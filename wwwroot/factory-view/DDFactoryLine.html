<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Dishdrawer Production Flow - Arrow Color</title>

    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

    <style>
        body {
            font-family: "Segoe UI", system-ui;
            background: linear-gradient(180deg, #eef2f7, #f8fafc);
            padding: 24px;
        }

        h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        #cy {
            height: 820px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
        }

        #tooltip {
            position: absolute;
            background: rgba(44,62,80,0.95);
            color: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -120%);
            transition: opacity 0.15s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            z-index: 999;
        }

            #tooltip b {
                color: #1abc9c;
            }

        .active {
            animation: glow 1.6s ease-in-out infinite;
        }

        @keyframes glow {
            0% {
                box-shadow: 0 0 0 0 rgba(52,152,219,0.35);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(52,152,219,0.08);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(52,152,219,0.35);
            }
        }
    </style>
</head>
<body>

    <h2>🏭 DISHDRAWER – Production Flow</h2>
    <div id="cy"></div>
    <div id="tooltip"></div>

    <script>
        (async () => {

            const params = new URLSearchParams(window.location.search);
            const line = params.get("line") || "DISHDRAWER";
            const serial = params.get("SerialNo");
            if (!serial) { alert("SerialNo is required"); return; }

            let layoutConfig = [];
            let trackHistory = [];

            // Fetch data
            try {
                const res = await fetch(`/api/FactoryLine/${line}?serial=${encodeURIComponent(serial)}`);
                if (!res.ok) throw new Error(res.status);

                const data = await res.json();

                layoutConfig = data.nodes.map(n => ({
                    store: n.store,
                    x: n.positionX,
                    y: n.positionY,
                    label: n.label
                }));

                trackHistory = data.history.filter(h => h.store_location);
            } catch (e) {
                console.error(e);
                alert("Load failed");
                return;
            }

            const statusColor = { P: "#27ae60", R: "#3498db", D: "#bdc3c7" };
            const trackingStatus = {};
            const historyMap = {};
            trackHistory.forEach(h => {
                trackingStatus[h.store_location] = h.status;
                historyMap[h.store_location] = h;
            });

            // Cytoscape init
            const cy = cytoscape({
                container: document.getElementById("cy"),
                layout: { name: "preset" },
                style: [
                    {
                        selector: "node",
                        style: {
                            label: "data(label)",
                            "background-color": "data(color)",
                            shape: "round-rectangle",
                            width: 140,
                            height: 56,
                            "font-size": 12,
                            "font-weight": 600,
                            color: "#fff",
                            "text-wrap": "wrap",
                            "text-max-width": 120,
                            "text-line-height": 1.4,
                            "text-valign": "center",
                            "text-halign": "center",
                            "overlay-opacity": 0
                        }
                    },
                    {
                        selector: "edge",
                        style: {
                            "curve-style": "bezier",
                            "target-arrow-shape": "triangle",
                            "arrow-scale": 0.9,
                            width: 2,
                            "line-color": "data(color)",
                            "target-arrow-color": "data(color)",
                            "line-opacity": 0.9
                        }
                    },
                    {
                        selector: "edge:hover",
                        style: {
                            width: 2,
                            "line-color": "#5dade2",
                            "target-arrow-color": "#5dade2"
                        }
                    }
                ]
            });

            // Assign Run Numbers
            let runNo = 1;
            const nodeRunMap = {};
            const sortedHistory = [...trackHistory].sort((a, b) => new Date(a.last_maint) - new Date(b.last_maint));
            sortedHistory.forEach(h => {
                if (!layoutConfig.find(n => n.store === h.store_location)) return;
                if (!nodeRunMap[h.store_location]) nodeRunMap[h.store_location] = [];
                nodeRunMap[h.store_location].push(runNo++);
            });

            // Add nodes
            layoutConfig.forEach(cfg => {
                const status = trackingStatus[cfg.store] || "D";
                let label = cfg.label;
                if (nodeRunMap[cfg.store]) {
                    label = nodeRunMap[cfg.store].map(n => `[${n}]`).join(" ") + "\n\n" + cfg.label;
                }
                cy.add({
                    data: { id: cfg.store, label, color: statusColor[status] },
                    position: { x: cfg.x * 10, y: (100 - cfg.y) * 6 }
                });
            });

            // Build run sequence
            const runSequence = [];
            Object.keys(nodeRunMap).forEach(store => {
                nodeRunMap[store].forEach(no => {
                    runSequence.push({ runNo: no, store });
                });
            });
            runSequence.sort((a, b) => a.runNo - b.runNo);

            // Draw edges with color = target node
            let delay = 0;
            for (let i = 1; i < runSequence.length; i++) {
                const from = runSequence[i - 1].store;
                const to = runSequence[i].store;
                if (cy.getElementById(from).empty() || cy.getElementById(to).empty()) continue;
                //const color = cy.getElementById(to).data("color");

                const color = "#878787";

                setTimeout(() => {
                    cy.add({
                        data: { id: `e-${from}-${to}-${i}`, source: from, target: to, color: color },
                        style: { "line-color": color, "target-arrow-color": color }
                    });
                }, delay);
                delay += 450;
            }

            // Highlight last node
            const lastRun = runSequence[runSequence.length - 1];
            if (lastRun) cy.getElementById(lastRun.store).addClass("active");

            cy.nodes().lock();

            // Tooltip
            const tooltip = document.getElementById("tooltip");
            cy.on("mouseover", "node", evt => {
                const n = evt.target;
                const h = historyMap[n.id()] || {};
                tooltip.innerHTML = `
                <b>${n.data("label").split("\n").pop()}</b><br/>
                Status: <b>${trackingStatus[n.id()] || "D"}</b><br/>
                User: ${h.last_maint_logon || "-"}<br/>
                Time: ${h.last_maint || "-"}
            `;
                tooltip.style.opacity = 1;
            });
            cy.on("mousemove", "node", evt => {
                tooltip.style.left = evt.originalEvent.pageX + "px";
                tooltip.style.top = evt.originalEvent.pageY + "px";
            });
            cy.on("mouseout", "node", () => { tooltip.style.opacity = 0; });

        })();
    </script>
</body>
</html>