<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Serial Lookup</title>

    <link href="css/normalize.min.css" rel="stylesheet" />
    <link href="css/SerialLook.css" rel="stylesheet" />

    <!-- ✅ XLSX -->
    <script src="js/xlsx.full.min.js"></script>
    <!-- ✅ Cytoscape -->
    <!--<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>-->
    <script src="js/cytoscape.min.js"></script>
    <style>
        /* Cytoscape container */
        #cy {
            height: 400px;
            width: 100%;
            margin-top: 16px;
            border-radius: 12px;
            background: #fff;
        }

        #tooltip {
            position: absolute;
            background: rgba(44,62,80,0.95);
            color: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -120%);
            transition: opacity 0.15s;
            z-index: 999;
        }

        .active {
            animation: glow 1.6s ease-in-out infinite;
        }

        @keyframes glow {
            0% {
                box-shadow: 0 0 0 0 rgba(52,152,219,0.35);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(52,152,219,0.08);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(52,152,219,0.35);
            }
        }
    </style>
</head>

<body>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="text">Loading...</div>
    </div>

    <div class="section left-card">

        <div class="two-tables-grid">

            <!-- Product Details -->
            <div>
                <h2>Serial Lookup (Live)</h2>
                <div>
                    <input type="text" id="serialInput" placeholder="Enter serial number">
                    <button onclick="loadData()">Search</button>
                </div>

                <table>
                    <tbody>
                        <tr><th>Serial FPA</th><td id="serialFPA"></td></tr>
                        <tr><th>Serial GEA</th><td id="serialGEA"></td></tr>
                        <tr><th>Serial HAIER</th><td id="serialHAIER"></td></tr>
                        <tr><th>Part</th><td id="part"></td></tr>
                        <tr><th>Part Issue</th><td id="partIssue"></td></tr>
                        <tr><th>Serial Issue Date</th><td id="serialIssueDate"></td></tr>
                        <tr><th>VAI Foam Code</th><td id="vaI_FoamCode"></td></tr>
                        <tr><th>Status</th><td id="status"></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Tracking Information -->
            <div>
                <button class="collapsible"><span class="arrow">▼</span> Tracking Information</button>
                <div class="content" id="tracking-content">
                    <table id="tracking-table">
                        <thead>
                            <tr>
                                <th>Workcell</th>
                                <th>Task</th>
                                <th>Store Location</th>
                                <th>Status</th>
                                <th>Store</th>
                                <th>Last Maint</th>
                                <th>Last Maint Logon</th>
                                <th>Update Ref</th>
                                <th>Order Number</th>
                                <th>Reject Reason</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Testing Information -->
        <button class="collapsible"><span class="arrow">▼</span> Testing Information</button>
        <div class="content" id="testing-content">
            <div style="margin-bottom: 2px;">
                <button onclick="exportTestingExcel()" title="Export Excel" style="font-size:16px; background: none; border: none; cursor: pointer; color: #333; display: flex; align-items: center;">
                    📊 <span style="margin-left: 2px;">Export Excel</span>
                </button>
            </div>
            <div id="testing-container"></div>
        </div>

        <!-- Rework Records -->
        <button class="collapsible"><span class="arrow">▼</span> Rework Records</button>
        <div class="content">
            <table id="rework-table">
                <thead>
                    <tr>
                        <th>Part</th>
                        <th>Date Recorded</th>
                        <th>Area</th>
                        <th>Repair Code</th>
                        <th>Fault Code</th>
                        <th>Mold</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Cytoscape Production Flow (BOTTOM) -->
        <button class="collapsible"><span class="arrow">▼</span> Production Flow</button>
        <div class="content">
            <div id="cy" style="height:800px;"></div>
            <div id="tooltip"></div>
        </div>

    </div>

    <script>
        /* ---------------- Collapsible ---------------- */
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".collapsible").forEach(btn => {
                const content = btn.nextElementSibling;
                if (!content) return;
                content.style.display = "none";
                btn.addEventListener("click", () => {
                    const isOpen = btn.classList.toggle("active");
                    content.style.display = isOpen ? "block" : "none";
                });
            });
        });

        /* ---------------- Dates ---------------- */
        const today = new Date();
        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
        const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
        function formatDate(dt) { const d = dt.getDate().toString().padStart(2, '0'); const m = (dt.getMonth() + 1).toString().padStart(2, '0'); const y = dt.getFullYear(); const h = dt.getHours().toString().padStart(2, '0'); const min = dt.getMinutes().toString().padStart(2, '0'); const s = dt.getSeconds().toString().padStart(2, '0'); return `${d}/${m}/${y} : ${h}:${min}:${s}`; }
        function formatDateYYYYMMDD(dt) { const y = dt.getFullYear(); const m = String(dt.getMonth() + 1).padStart(2, "0"); const d = String(dt.getDate()).padStart(2, "0"); return `${y}-${m}-${d}`; }

        /* ---------------- Load Data ---------------- */
        async function loadData() {
            const serial = document.getElementById("serialInput").value.trim();
            if (!serial) { alert("Please enter a serial number."); return; }

            const overlay = document.getElementById("loading");
            overlay.style.display = "flex";

            try {
                const response = await fetch(`./api/Product/${serial}`);
                overlay.style.display = "none";
                if (!response.ok) { alert("Product not found."); return; }

                const data = await response.json();

                // --- Product details ---
                const pd = data.productDetails || {};
                document.getElementById("serialFPA").textContent = pd.serialFPA || "-";
                document.getElementById("serialGEA").textContent = pd.serialGEA || "-";
                document.getElementById("serialHAIER").textContent = pd.serialHAIER || "-";
                document.getElementById("part").textContent = pd.part || "-";
                document.getElementById("partIssue").textContent = pd.partIssue || "-";
                document.getElementById("serialIssueDate").textContent = pd.serialIssueDate ? formatDate(new Date(pd.serialIssueDate)) : "-";
                document.getElementById("vaI_FoamCode").textContent = pd.vaI_FoamCode || "-";
                const statusEl = document.getElementById("status"); statusEl.textContent = pd.status || "-"; statusEl.className = ''; if (pd.status) statusEl.classList.add(`status-${pd.status}`);

                // ---------------- Expand Sections Automatically ----------------
                function expandSectionByText(text) {
                    const buttons = document.querySelectorAll("button.collapsible");
                    buttons.forEach(btn => {
                        if (btn.textContent.includes(text)) {
                            const content = btn.nextElementSibling;
                            btn.classList.add("active");
                            if (content) content.style.display = "block";
                        }
                    });
                }

                // After loading serial data
                expandSectionByText("Tracking Information");
                expandSectionByText("Testing Information");
                expandSectionByText("Production Flow");

                // --- Clear old tables ---
                ["#tracking-table tbody", "#rework-table tbody"].forEach(sel => { document.querySelector(sel).innerHTML = ""; });

                // --- Tracking ---
                if (data.tracking && data.tracking.length > 0) {
                    data.tracking.forEach(t => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `<td>${t.workcell}</td><td>${t.task}</td><td>${t.store_location}</td><td class="status-${t.status}">${t.status}</td><td>${t.store}</td><td>${t.last_maint ? formatDate(new Date(t.last_maint)) : '-'}</td><td>${t.last_maint_logon || '-'}</td><td>${t.update_reference || '-'}</td><td>${t.order_no || '-'}</td><td>${t.reject_reason || '-'}</td>`;
                        document.querySelector("#tracking-table tbody").appendChild(tr);
                    });
                } else {
                    const tr = document.createElement("tr"); tr.innerHTML = `<td colspan="10" style="text-align:center;">No tracking data found</td>`; document.querySelector("#tracking-table tbody").appendChild(tr);
                }

                // --- Testing ---
                window.testingData = data.testing || [];
                const testingContainer = document.getElementById("testing-container"); testingContainer.innerHTML = "";
                if (data.testing && data.testing.length > 0) {
                    const grouped = {};
                    data.testing.forEach(t => { if (!grouped[t.task]) grouped[t.task] = {}; if (!grouped[t.task][t.run]) grouped[t.task][t.run] = []; grouped[t.task][t.run].push(t); });
                    Object.keys(grouped).forEach(taskId => {
                        const taskDiv = document.createElement('div'); taskDiv.className = 'task';
                        const runs = Object.keys(grouped[taskId]).sort((a, b) => a - b);
                        const latestRunItems = grouped[taskId][runs[runs.length - 1]];
                        const latestPass = latestRunItems.every(i => i.testStatus !== "F");
                        const latestResultClass = latestPass ? 'pass' : 'fail';
                        const taskHeader = document.createElement('div'); taskHeader.className = 'task-header';
                        const taskDescription = latestRunItems[0].taskDescription || '';
                        taskHeader.innerHTML = `<a href="http://tiger/QA_LISSummary/ResultPartTest?startDate=${formatDateYYYYMMDD(yesterday)}&endDate=${formatDateYYYYMMDD(tomorrow)}&TaskNo=${taskId}" target="_blank" class="task-link">TASK ${taskId} ${taskDescription}</a> • <span class="${latestResultClass}">&nbsp${latestPass ? 'PASS' : 'FAIL'}</span>`;
                        taskDiv.appendChild(taskHeader);
                        const runsContainer = document.createElement('div'); runsContainer.className = 'runs-container'; runsContainer.style.display = 'none';
                        runs.forEach(runNum => {
                            const runDiv = document.createElement('div'); runDiv.className = 'run';
                            const runItems = grouped[taskId][runNum]; const runFail = runItems.some(i => i.testStatus === "F"); const runPass = !runFail; const runResultClass = runPass ? 'pass' : 'fail';
                            const lastDateTested = runItems.map(r => r.dateTested).filter(d => d).map(d => new Date(d)).sort((a, b) => b - a)[0];
                            const runHeader = document.createElement('div'); runHeader.className = 'run-header'; if (runFail) runHeader.style.backgroundColor = '#ffe5e5';
                            runHeader.innerHTML = `Task ${taskId} • Run: ${runNum} • ${lastDateTested ? '🕒 ' + formatDate(lastDateTested) : ''} <span class="${runResultClass}">${runPass ? '✅' : '❌'}</span>`;
                            const itemsDiv = document.createElement('div'); itemsDiv.className = 'test-items'; itemsDiv.style.display = 'none';
                            runItems.forEach(item => {
                                const isFail = item.testStatus === "F"; const span = document.createElement('div'); span.innerHTML = `<div class="test-row ${isFail ? 'row-fail' : ''}"><div class="col part"><a href="http://tiger/LIS_ITEM/ItemCheck/GETPTBYCATASK?Part=&taskChk=&partNo=${item.testPart}" target="_blank">${item.testPart}</a></div><div class="col description">${item.description || '-'}</div><div class="col result"><span class="test-result">${item.testResult || '-'}</span></div><div class="col status"><span class="${isFail ? 'fail' : 'pass'}">${isFail ? '❌' : '✅'}</span></div></div>`; itemsDiv.appendChild(span);
                            });
                            runHeader.addEventListener('click', () => { itemsDiv.style.display = itemsDiv.style.display === 'block' ? 'none' : 'block'; });
                            runDiv.appendChild(runHeader); runDiv.appendChild(itemsDiv); runsContainer.appendChild(runDiv);
                        });
                        taskHeader.addEventListener('click', () => { runsContainer.style.display = runsContainer.style.display === 'block' ? 'none' : 'block'; });
                        taskDiv.appendChild(runsContainer); testingContainer.appendChild(taskDiv);
                    });
                } else { testingContainer.innerHTML = "<div style='text-align:center;'>No testing data found</div>"; }

                // --- Rework ---
                if (data.reworkRecords && data.reworkRecords.length > 0) {
                    data.reworkRecords.forEach(r => {
                        const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.part}</td><td>${r.dateRecorded ? formatDate(new Date(r.dateRecorded)) : '-'}</td><td>${r.areaRecorded}</td><td>${r.rwkRepairCode}</td><td>${r.rwkFaultCode}</td><td>${r.mold}</td>`;
                        document.querySelector("#rework-table tbody").appendChild(tr);
                    });
                } else { const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="6" style="text-align:center;">No rework records found</td>`; document.querySelector("#rework-table tbody").appendChild(tr); }

                // --- Cytoscape Production Flow ---
                loadProductionFlow(serial);

            } catch (err) { overlay.style.display = "none"; console.error(err); alert("Failed to load product data."); }
        }

        /* ---------------- Cytoscape Flow ---------------- */
        async function loadProductionFlow(serial) {
            const params = new URLSearchParams(); params.set("SerialNo", serial); const line = "DISHDRAWER";
            let layoutConfig = [], trackHistory = [];
            try {
                const res = await fetch(`./api/FactoryLine/${line}?serial=${encodeURIComponent(serial)}`);
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                layoutConfig = data.nodes.map(n => ({ store: n.store, x: n.positionX, y: n.positionY, label: n.label }));
                trackHistory = data.history.filter(h => h.store_location);
            } catch (e) { console.error(e); alert("Flow load failed"); return; }

            const statusColor = { P: "#27ae60", R: "#3498db", D: "#bdc3c7" };
            const trackingStatus = {}; const historyMap = {};
            trackHistory.forEach(h => { trackingStatus[h.store_location] = h.status; historyMap[h.store_location] = h; });

            const cy = cytoscape({
                container: document.getElementById("cy"),
                layout: { name: "preset" },
                style: [
                    { selector: "node", style: { label: "data(label)", "background-color": "data(color)", shape: "round-rectangle", width: 140, height: 56, "font-size": 12, "font-weight": 600, color: "#fff", "text-wrap": "wrap", "text-max-width": 120, "text-line-height": 1.4, "text-valign": "center", "text-halign": "center", "overlay-opacity": 0 } },
                    { selector: "edge", style: { "curve-style": "bezier", "target-arrow-shape": "triangle", "arrow-scale": 0.9, width: 2, "line-color": "data(color)", "target-arrow-color": "data(color)", "line-opacity": 0.9 } },
                    { selector: "edge:hover", style: { width: 2, "line-color": "#5dade2", "target-arrow-color": "#5dade2" } }
                ]
            });

            // Assign run numbers
            let runNo = 1, nodeRunMap = {};
            [...trackHistory].sort((a, b) => new Date(a.last_maint) - new Date(b.last_maint)).forEach(h => {
                if (!layoutConfig.find(n => n.store === h.store_location)) return;
                if (!nodeRunMap[h.store_location]) nodeRunMap[h.store_location] = [];
                nodeRunMap[h.store_location].push(runNo++);
            });

            // Add nodes
            layoutConfig.forEach(cfg => {
                const status = trackingStatus[cfg.store] || "D";
                let label = cfg.label; if (nodeRunMap[cfg.store]) label = nodeRunMap[cfg.store].map(n => `[${n}]`).join(" ") + "\n\n" + cfg.label;
                cy.add({ data: { id: cfg.store, label, color: statusColor[status] }, position: { x: cfg.x * 10, y: (100 - cfg.y) * 6 } });
            });

            // Draw edges
            const runSequence = []; Object.keys(nodeRunMap).forEach(store => nodeRunMap[store].forEach(no => { runSequence.push({ runNo: no, store }); }));
            runSequence.sort((a, b) => a.runNo - b.runNo);
            let delay = 0;
            for (let i = 1; i < runSequence.length; i++) {
                const from = runSequence[i - 1].store; const to = runSequence[i].store;
                if (cy.getElementById(from).empty() || cy.getElementById(to).empty()) continue;
                const color = "#878787";
                setTimeout(() => { cy.add({ data: { id: `e-${from}-${to}-${i}`, source: from, target: to, color: color }, style: { "line-color": color, "target-arrow-color": color } }); }, delay);
                delay += 450;
            }

            const lastRun = runSequence[runSequence.length - 1]; if (lastRun) cy.getElementById(lastRun.store).addClass("active");
            cy.nodes().lock();
            cy.userZoomingEnabled(false);             // allow zoom
            cy.userPanningEnabled(false);             // allow pan
            cy.boxSelectionEnabled(false);           // optional: disable box select
            cy.autoungrabify(true);                  // optional: prevent dragging nodes

            // Tooltip
            const tooltip = document.getElementById("tooltip");
            cy.on("mouseover", "node", evt => {
                const n = evt.target;
                const h = historyMap[n.id()] || {};
                tooltip.innerHTML = `
        <b>${n.data("label").split("\n").pop()}</b><br/>
        Status: <b>${trackingStatus[n.id()] || "D"}</b><br/>
        User: ${h.last_maint_logon || "-"}<br/>
        Time: ${h.last_maint}
    `;
                tooltip.style.opacity = 1;
            });
            cy.on("mousemove", "node", evt => {
                tooltip.style.top = (evt.originalEvent.pageY - 12) + "px";
                tooltip.style.left = (evt.originalEvent.pageX + 6) + "px";
            });
            cy.on("mouseout", "node", () => { tooltip.style.opacity = 0; });
        }

        /* ---------------- Export Excel ---------------- */
        function exportTestingExcel() {
            if (!window.testingData || window.testingData.length === 0) { alert("No testing data to export"); return; }
            const wb = XLSX.utils.book_new(); const ws_data = [];
            window.testingData.forEach(t => { ws_data.push([t.task, t.run, t.testPart, t.description, t.testResult, t.testStatus]); });
            const ws = XLSX.utils.aoa_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "Testing"); XLSX.writeFile(wb, "testing.xlsx");
        }


    </script>
</body>
</html>
